worker_processes auto;

error_log logs/error_log debug;

events {
  worker_connections 1024;
}

env ENV_OSS_ENDPOINT_HOST;
env ENV_OSS_ENDPOINT_PORT;
env ENV_OSS_ENDPOINT_LOCATION;
env OSS_ENDPOINT_LOCATION;
env ENV_OSS_AK;
env ENV_OSS_SK;
env AWS_ACCESS_KEY_ID;
env AWS_SECRET_ACCESS_KEY;
env NGINX_ACCESS_CORS_ALLOWED_ORIGIN;
env NGINX_UPSTREAM_MINIO_SERVER;
env NGINX_UPSTREAM_IMGPROXY_SERVER;
env ENV_JWT_VALID_ISSUER;
env ENV_JWT_VALID_SUBJECT;

http {
  {{ if getenv "NGINX_RESOLVER_ADDR" -}}
  resolver {{ getenv "NGINX_RESOLVER_ADDR" -}};
  {{- end }}
  lua_package_path '$prefix/lua/?.lua;;';
  lua_shared_dict globals 2m;

  init_by_lua_block {
    local success, err = pcall(function()
    end)
  }

  upstream minio-server {
    least_conn;
    server {{ getenv "NGINX_UPSTREAM_MINIO_SERVER" }};
  }

  upstream imgproxy-server {
    least_conn;
    server {{ getenv "NGINX_UPSTREAM_IMGPROXY_SERVER" }};
  }

  error_page 500 502 503 504 @error_50x;

  proxy_cache_path /var/cache/nginx/imgproxy levels=1:2 keys_zone=imgproxy_cache:10m inactive=7d max_size=10g use_temp_path=off;

  server {
    server_name s1-file.whimer.com;
    listen 80;
    listen [::]:80;

    location @error_50x {
      internal;
      rewrite_log on;
      content_by_lua_block {
        ngx.header["Content-Type"] = "application/json"
        ngx.status = 500
        ngx.say('{"code": -1, "msg": "internal server error"}')
        ngx.exit(ngx.HTTP_OK)
      }
    }

    location ~ ^/imgproxyserver/(nota|avatar|pics)(/.*)$ {
      internal;

      rewrite ^/imgproxyserver/(nota|avatar|pics)(.*)$ $2 break;

      # cache settings
      proxy_cache imgproxy_cache;
      proxy_cache_lock on;
      proxy_cache_key "$request_method$scheme$proxy_host$uri$is_args$args";
      proxy_cache_valid 200 302 304 24h;
      proxy_cache_valid any 1m;
      proxy_ignore_headers Cache-Control Expires;
      add_header X-Cache-Status $upstream_cache_status;

      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_connect_timeout 300;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      chunked_transfer_encoding off;

      proxy_pass http://imgproxy-server;
    }

    location ~* ^/(nota|avatar|pics)/ {
      access_by_lua_file lua/s1-file/check.lua;
      content_by_lua_file lua/s1-file/handle.lua;
    }

    location ~* ^/videos/ {
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # Range 请求支持（拖动进度条、断点续传）
      proxy_set_header Range $http_range;
      proxy_set_header If-Range $http_if_range;
      proxy_force_ranges on;

      # 超时设置（视频传输时间长）
      proxy_connect_timeout 60;
      proxy_send_timeout 300;
      proxy_read_timeout 300;

      # HTTP/1.1 长连接
      proxy_http_version 1.1;
      proxy_set_header Connection "";

      # 视频流式传输，不缓存不缓冲
      proxy_buffering off;
      proxy_cache off;

      gzip off;

      proxy_pass http://minio-server;
    }
  }

  server {
    server_name s1-upload.whimer.com;
    listen 80;
    listen [::]:80;

    location ^~ /nota/ {
      client_max_body_size 10m;
      client_body_buffer_size 10m;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      access_by_lua_file lua/s1-upload/check_v2.lua;
      proxy_pass http://minio-server;
    }

    location ^~ /pics/ {
      client_max_body_size 10m;
      client_body_buffer_size 10m;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://minio-server;

      access_by_lua_file lua/s1-upload/check.lua;
      content_by_lua_file lua/s1-upload/handle.lua;
      log_by_lua_file lua/s1-upload/post.lua;
    }

    location ^~ /videos/ {
      client_max_body_size 10m;
      client_body_buffer_size 10m;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      access_by_lua_file lua/s1-upload/check_v2.lua;
      proxy_pass http://minio-server;
    }
  }
}